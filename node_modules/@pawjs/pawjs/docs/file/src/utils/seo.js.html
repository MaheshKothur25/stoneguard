<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/utils/seo.js | @pawjs/pawjs</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A minimal pluggable reactjs framework to develop a progressive web application"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="@pawjs/pawjs"><meta property="twitter:description" content="A minimal pluggable reactjs framework to develop a progressive web application"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/Atyantik/pawjs"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server">server</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-afterStart">afterStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-beforeStart">beforeStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-server">server</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateMeta">generateMeta</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTextFromHtml">getTextFromHtml</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-trimTillLastSentence">trimTillLastSentence</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-assetsToArray">assetsToArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateStringHash">generateStringHash</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isBrowser">isBrowser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadScript">loadScript</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadStyle">loadStyle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-possibleStandardNames">possibleStandardNames</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-metaKeys">metaKeys</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#webpack">webpack</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/webpack/handler.js~WebpackHandler.html">WebpackHandler</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/utils/seo.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import _ from &apos;lodash&apos;;
import { isBrowser } from &apos;./utils&apos;;

const defaultMeta = pwaSchema =&gt; [
  {
    charSet: &apos;utf-8&apos;,
  },
  {
    name: &apos;robots&apos;,
    content: &apos;all&apos;,
  },
  {
    name: &apos;author&apos;,
    content: &apos;Atyantik Technologies Private Limited&apos;,
  },
  {
    httpEquiv: &apos;x-ua-compatible&apos;,
    content: &apos;ie=edge&apos;,
  },
  {
    name: &apos;viewport&apos;,
    content: &apos;width=device-width, initial-scale=1, shrink-to-fit=no&apos;,
  },
  {
    name: &apos;application-name&apos;,
    content: _.get(pwaSchema, &apos;name&apos;, &apos;&apos;),
  },
  {
    name: &apos;generator&apos;,
    content: &apos;PawJS&apos;,
  },
  {
    name: &apos;rating&apos;,
    content: &apos;General&apos;,
  },
  {
    name: &apos;mobile-web-app-capable&apos;,
    content: &apos;yes&apos;,
  },
  {
    name: &apos;apple-mobile-web-app-capable&apos;,
    content: &apos;yes&apos;,
  },
  {
    name: &apos;apple-mobile-web-app-status-bar-style&apos;,
    content: _.get(pwaSchema, &apos;theme_color&apos;, &apos;#fff&apos;),
  },
  {
    name: &apos;apple-mobile-web-app-title&apos;,
    content: _.get(pwaSchema, &apos;name&apos;, &apos;&apos;),
  },
  {
    name: &apos;msapplication-tooltip&apos;,
    content: _.get(pwaSchema, &apos;description&apos;, &apos;&apos;),
  },
  {
    name: &apos;msapplication-starturl&apos;,
    content: _.get(pwaSchema, &apos;start_url&apos;, &apos;&apos;),
  },
  {
    name: &apos;msapplication-TileColor&apos;,
    content: _.get(pwaSchema, &apos;background_color&apos;, &apos;#fff&apos;),
  },
  {
    name: &apos;renderer&apos;,
    content: &apos;webkit|ie-comp|ie-stand&apos;,
  },
  {
    name: &apos;full-screen&apos;,
    content: &apos;yes&apos;,
  },

];

/**
 * Standard meta keys to differentiate
 * @type {[*]}
 */
export const metaKeys = [
  &apos;name&apos;,
  &apos;itemProp&apos;,
  &apos;property&apos;,
  &apos;charSet&apos;,
];

/**
 * Get full url appended with base url if no protocol present in the provided link
 * @param url
 * @param baseUrl
 * @returns {*}
 */
const getFullUrl = (url, baseUrl = &apos;&apos;) =&gt; {
  let fullImageUrl = url;
  if (!_.startsWith(fullImageUrl, &apos;http&apos;)) {
    fullImageUrl = `${baseUrl}${!_.startsWith(fullImageUrl, &apos;/&apos;) ? &apos;/&apos; : &apos;&apos;}${fullImageUrl}`;
  }
  return fullImageUrl;
};

/**
 * Return the meta key detected from the meta provided.
 * if no meta key from our standard metaKeys is found then return false
 * @param meta
 * @returns {boolean|string}
 */
const getMetaKey = (meta) =&gt; {
  let selectedMetaKey = false;
  _.each(metaKeys, (key) =&gt; {
    if (!selectedMetaKey &amp;&amp; _.get(meta, key, false)) {
      selectedMetaKey = key;
    }
  });
  return selectedMetaKey;
};

/**
 * Update the source directly,
 * thus pass as array
 * @param source {Array}
 * @param customMetas {Array}
 */
const addUpdateMeta = (source = [], customMetas = []) =&gt; {
  _.each(customMetas, (meta) =&gt; {
    const metaKey = getMetaKey(meta);
    let metaUpdated = false;
    if (metaKey) {
      // Suppose we got a meta key in our generatedSchema
      // then we need to update the generated schema
      const generatedSchemaObj = _.find(source, { [metaKey]: meta[metaKey] });

      if (generatedSchemaObj) {
        _.each(meta, (value, key) =&gt; {
          _.set(generatedSchemaObj, key, value);
        });
        metaUpdated = true;
      }
    }
    // This means user is trying to add some meta that does
    // not match our standard criteria or is not present in our source, maybe for site verification
    // or google webmaster meta key etc
    if (!metaUpdated) {
      // Add data to source
      source.push(meta);
    }
  });
};

/**
 * Get text from html string
 * @param str
 * @returns {string}
 */
export const getTextFromHtml = (str = &apos;&apos;) =&gt; str.replace(/&lt;(?:.|\n)*?&gt;/gm, &apos;&apos;).trim();

/**
 * Return array of meta tags required for the route
 * Pass seo data to the function and get array of meta data
 * @param data
 * @param options
 * @returns {Array}
 */
export const generateMeta = (data = {}, options = {
  baseUrl: &apos;&apos;, url: &apos;&apos;, pwaSchema: {}, seoSchema: {},
}) =&gt; {
  // deep defaults the seoSchema we have in config file and the data provided to us.
  const seoData = _.defaultsDeep(data, options.seoSchema);

  // Let store the generated Schema in following variable
  let generatedSchema = [];

  const descriptionText = getTextFromHtml(seoData.description);
  // Get 155 words out of description
  // const desc155words = trimTillLastSentence(seoData.description, 155);
  const desc155chars = descriptionText.slice(0, 155);

  // Get 200 words out of description
  const desc200chars = descriptionText.slice(0, 200);

  // const desc200words = trimTillLastSentence(seoData.description, 200);

  // Base url after removing the end slash
  const baseUrl = options.baseUrl.replace(/\/$/, &apos;&apos;);

  // Add meta required for at top of head
  addUpdateMeta(generatedSchema, _.cloneDeep(defaultMeta(options.pwaSchema)));

  /**
   * Manage name/title
   */
  // Meta name
  generatedSchema.push({
    name: &apos;title&apos;,
    content: seoData.title,
  });
  // Twitter title
  generatedSchema.push({
    name: &apos;twitter:title&apos;,
    content: seoData.title,
  });
  generatedSchema.push({
    property: &apos;og:title&apos;,
    content: seoData.title,
  });

  /**
   * Manage keywords (allow string and array as well)
   */
  if (_.isString(seoData.keywords) &amp;&amp; seoData.keywords.trim().length) {
    generatedSchema.push({
      name: &apos;keywords&apos;,
      content: seoData.keywords,
    });
  }
  if (_.isArray(seoData.keywords) &amp;&amp; seoData.keywords.length) {
    generatedSchema.push({
      name: &apos;keywords&apos;,
      content: seoData.keywords.join(&apos;,&apos;),
    });
  }

  /**
   * Manage twitter site &amp; author
   */
  const twitterSite = _.get(seoData, &apos;twitter.site&apos;, &apos;&apos;);
  if (twitterSite.length) {
    generatedSchema.push({
      name: &apos;twitter:site&apos;,
      content: twitterSite,
    });
  }

  const twitterCreator = _.get(seoData, &apos;twitter.creator&apos;, &apos;&apos;);
  if (twitterCreator.length) {
    generatedSchema.push({
      name: &apos;twitter:creator&apos;,
      content: twitterCreator,
    });
  }

  /**
   * Manage facebook admins
   */
  const fbAdmins = _.get(seoData, &apos;facebook.admins&apos;, []);
  if (fbAdmins &amp;&amp; fbAdmins.length) {
    generatedSchema.push({
      property: &apos;fb:admins&apos;,
      content: fbAdmins.join(&apos;,&apos;),
    });
  }

  /**
   * Manage description
   */
  // Meta description
  generatedSchema.push({
    name: &apos;description&apos;,
    content: desc155chars,
  });
  generatedSchema.push({
    name: &apos;twitter:description&apos;,
    content: desc200chars,
  });
  generatedSchema.push({
    property: &apos;og:description&apos;,
    content: descriptionText,
  });

  /**
   * Site name
   */
  if (seoData.site_name.length) {
    generatedSchema.push({
      property: &apos;og:site_name&apos;,
      content: seoData.site_name,
    });
  }

  /**
   * Manage Primary Image
   */
  const hasImage = !!seoData.image.length;

  if (hasImage) {
    let images = hasImage ? seoData.image : [];
    if (!_.isArray(images)) {
      images = [images];
    }

    const image = _.first(images);
    const fullImageUrl = getFullUrl(image, baseUrl);
    generatedSchema.push({
      itemProp: &apos;image&apos;,
      content: fullImageUrl,
    });
    generatedSchema.push({
      name: &apos;twitter:image:src&apos;,
      content: fullImageUrl,
    });
    if (image.length &gt; 1) {
      _.each(images, (img) =&gt; {
        generatedSchema.push({
          property: &apos;og:image&apos;,
          content: getFullUrl(img, baseUrl),
        });
      });
    } else {
      generatedSchema.push({
        property: &apos;og:image&apos;,
        content: fullImageUrl,
      });
    }

    // Add type of twitter card
    generatedSchema.push({
      name: &apos;twitter:card&apos;,
      content: &apos;summary_large_image&apos;,
    });
  } else {
    generatedSchema.push({
      name: &apos;twitter:card&apos;,
      content: &apos;summary&apos;,
    });
  }

  /**
   * Manage Type article/product/music/movie etc
   */
  generatedSchema.push({
    property: &apos;og:type&apos;,
    content: seoData.type,
  });

  let twitterDataCounter = 1;
  _.each(seoData.type_details, (value, key) =&gt; {
    if (_.isObject(value)) {
      _.each(value, (subValue, subKey) =&gt; {
        if (!_.isEmpty(subValue)) {
          generatedSchema.push({
            property: `${seoData.type}:${key}:${subKey}`,
            content: subValue,
          });
          generatedSchema.push({
            name: `twitter:data${twitterDataCounter}`,
            content: subValue,
          });
          generatedSchema.push({
            name: `twitter:label${twitterDataCounter}`,
            content: subKey,
          });
          twitterDataCounter += 1;
        }
      });
    } else if (!_.isEmpty(value)) {
      generatedSchema.push({
        property: `${seoData.type}:${key}`,
        content: value,
      });
      generatedSchema.push({
        name: `twitter:data${twitterDataCounter}`,
        content: value,
      });
      generatedSchema.push({
        name: `twitter:label${twitterDataCounter}`,
        content: key,
      });
      twitterDataCounter += 1;
    }
  });

  let url = _.get(seoData, &apos;url&apos;, _.get(options, &apos;url&apos;, &apos;&apos;));
  if (!url.length &amp;&amp; isBrowser()) {
    url = _.get(window, &apos;location.href&apos;, &apos;&apos;);
  }
  if (url.trim().length) {
    generatedSchema.push({
      property: &apos;og:url&apos;,
      content: url,
    });
  }

  const userMeta = _.get(seoData, &apos;meta&apos;, []);
  addUpdateMeta(generatedSchema, userMeta);

  generatedSchema = _.uniqWith(generatedSchema, _.isEqual);

  return generatedSchema;
};

/**
 * Process string to get appropriate trimmed data
 * Thus string &quot;Tirth Bodawala&quot; should return &quot;Tirth Bodawala&quot; with length 14
 * &amp; should return &quot;Tirth&quot; with length 13, first it tries to search for &quot;.&quot; and then
 * for &quot; &quot;(space)
 * @param str
 * @param length
 * @returns String
 */
export const trimTillLastSentence = (str, length = 0) =&gt; {
  // Get pure text from string provided, necessary
  // to remove html tags
  let strr = getTextFromHtml(str);

  // If no min length specified or no string
  // length then return string
  if (!length || !strr.length) {
    return strr;
  }

  // Add leading space to preserve string length
  strr += &apos; &apos;;

  // trim the string to the maximum length
  let trimmedString = strr.substr(0, length + 1);

  // Re-trim if we are in the middle of a word
  let separator = &apos;.&apos;;

  // Check if there is a sentence and a &quot;.&quot; exists
  if (trimmedString.lastIndexOf(separator) === -1) {
    separator = &apos; &apos;;
    if (trimmedString.lastIndexOf(separator) === -1) {
      // if no space exists at all then return the string
      // with max length value
      trimmedString = str.substr(0, length);
      return trimmedString;
    }
  }
  return trimmedString.substr(
    0,
    Math.min(trimmedString.length - 1, trimmedString.lastIndexOf(separator)),
  ).trim();
};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
