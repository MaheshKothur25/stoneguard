<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/server/webpack-build.js | @pawjs/pawjs</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A minimal pluggable reactjs framework to develop a progressive web application"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="@pawjs/pawjs"><meta property="twitter:description" content="A minimal pluggable reactjs framework to develop a progressive web application"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/Atyantik/pawjs"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server">server</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-afterStart">afterStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-beforeStart">beforeStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-server">server</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateMeta">generateMeta</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTextFromHtml">getTextFromHtml</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-trimTillLastSentence">trimTillLastSentence</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-assetsToArray">assetsToArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateStringHash">generateStringHash</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isBrowser">isBrowser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadScript">loadScript</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadStyle">loadStyle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-possibleStandardNames">possibleStandardNames</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-metaKeys">metaKeys</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#webpack">webpack</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/webpack/handler.js~WebpackHandler.html">WebpackHandler</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/server/webpack-build.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import path from &apos;path&apos;;
import fs from &apos;fs&apos;;
import del from &apos;del&apos;;
import mv from &apos;mv&apos;;
import request from &apos;supertest&apos;;
import webpack from &apos;webpack&apos;;
import CleanWebpackPlugin from &apos;clean-webpack-plugin&apos;;
import CopyWebpackPlugin from &apos;copy-webpack-plugin&apos;;
import pawConfig from &apos;../config&apos;;
import directories from &apos;../webpack/utils/directories&apos;;


import wHandler from &apos;../webpack&apos;;
import webRule from &apos;../webpack/inc/babel-web-rule&apos;;
import serverRule from &apos;../webpack/inc/babel-server-rule&apos;;
import SyncedFilesPlugin from &apos;../webpack/plugins/synced-files-plugin&apos;;
import ExtractEmittedAssets from &apos;../webpack/plugins/extract-emitted-assets&apos;;

const isVerbose = process.env.PAW_VERBOSE === &apos;true&apos;;

const stats = {
  // fallback value for stats options when
  // an option is not defined (has precedence over local webpack defaults)
  all: undefined,

  // Add asset Information
  assets: true,

  // Sort assets by a field
  // You can reverse the sort with `!field`.
  assetsSort: &apos;field&apos;,

  // Add build date and time information
  builtAt: true,

  // Add information about cached (not built) modules
  cached: isVerbose,

  // Show cached assets (setting this to `false` only shows emitted files)
  cachedAssets: isVerbose,

  // Add children information
  children: true,

  // Add chunk information (setting this to `false` allows for a less verbose output)
  chunks: isVerbose,

  // Add namedChunkGroups information
  chunkGroups: isVerbose,

  // Add built modules information to chunk information
  chunkModules: isVerbose,

  // Add the origins of chunks and chunk merging info
  chunkOrigins: isVerbose,

  // Sort the chunks by a field
  // You can reverse the sort with `!field`. Default is `id`.
  chunksSort: &apos;field&apos;,

  // Context directory for request shortening
  context: directories.src,

  // `webpack --colors` equivalent
  colors: true,

  // Display the distance from the entry point for each module
  depth: isVerbose,

  // Display the entry points with the corresponding bundles
  entrypoints: isVerbose,

  // Add --env information
  env: true,

  // Add errors
  errors: true,

  // Add details to errors (like resolving log)
  errorDetails: true,

  // Add the hash of the compilation
  hash: true,

  // Set the maximum number of modules to be shown
  maxModules: 0,

  // Add built modules information
  modules: isVerbose,

  // Sort the modules by a field
  // You can reverse the sort with `!field`. Default is `id`.
  modulesSort: &apos;field&apos;,

  // Show dependencies and origin of warnings/errors (since webpack 2.5.0)
  moduleTrace: isVerbose,

  // Show performance hint when file size exceeds `performance.maxAssetSize`
  performance: true,

  // Show the exports of the modules
  providedExports: false,

  // Add public path information
  publicPath: true,

  // Add information about the reasons why modules are included
  reasons: isVerbose,

  // Add the source code of modules
  source: false,

  // Add timing information
  timings: true,

  // Show which exports of a module are used
  usedExports: false,

  // Add webpack version information
  version: isVerbose,

  // Add warnings
  warnings: true,
  profile: true,

  // Filter warnings to be shown (since webpack 2.4.0),
  // can be a String, Regexp, a function getting the warning and returning a boolean
  // or an Array of a combination of the above. First match wins.
  warningsFilter: warning =&gt; (
    warning.indexOf(&apos;node_modules/express&apos;) !== -1
    || warning.indexOf(&apos;node_modules/encoding&apos;) !== -1
  ),
};

// Notify the user that compilation has started and should be done soon.

// eslint-disable-next-line
console.log(`
===================================================
  Building application...
  This may take time depending on the application size.
  Thank you for your patience.
===================================================
`);
const imageExtensions = [
  &apos;jpg&apos;,
  &apos;jpeg&apos;,
  &apos;png&apos;,
  &apos;gif&apos;,
  &apos;svg&apos;,
  &apos;webp&apos;,
];
const isImageRule = (rule) =&gt; {
  let isValid = true;
  imageExtensions.forEach((ext) =&gt; {
    if (!isValid) return;
    isValid = rule.test.test(`.${ext}`);
  });
  return isValid;
};


const isBabelRule = (rule) =&gt; {
  if (
    rule
    &amp;&amp; rule.use
    &amp;&amp; Array.isArray(rule.use)
    &amp;&amp; rule.use.some(u =&gt; u.loader === &apos;babel-loader&apos;)
  ) {
    return true;
  }

  return (
    rule
    &amp;&amp; rule.use
    &amp;&amp; typeof rule.use === &apos;object&apos;
    &amp;&amp; rule.use.loader === &apos;babel-loader&apos;
  );
};
const hasSyncedFileLoader = (rule) =&gt; {
  let hasSyncFile = false;
  if (rule.use &amp;&amp; rule.use.length) {
    rule.use.forEach((u) =&gt; {
      if (hasSyncFile) return;

      if (u.loader === path.resolve(__dirname, &apos;../webpack/plugins/synced-files-plugin/loader.js&apos;)) {
        hasSyncFile = true;
      }
    });
  }

  if (rule.oneOf &amp;&amp; rule.oneOf.length) {
    rule.oneOf.forEach((oneOf) =&gt; {
      if (hasSyncFile) return;

      oneOf.use.forEach((u) =&gt; {
        if (hasSyncFile) return;

        if (u.loader === path.resolve(__dirname, &apos;../webpack/plugins/synced-files-plugin/loader.js&apos;)) {
          hasSyncFile = true;
        }
      });
    });
  }
  return hasSyncFile;
};

let cleanDistFolder = false;
let copyPublicFolder = !fs.existsSync(path.join(directories.src, &apos;public&apos;));
wHandler.hooks.beforeConfig.tap(&apos;AddSyncedFilesPlugin&apos;, (wEnv, wType, wConfigs) =&gt; {
  // Web specific configurations
  if (wType === &apos;web&apos;) {
    wConfigs.forEach((wConfig) =&gt; {
      if (!cleanDistFolder) {
        const hasCleanWebpackPlugin = wConfig.plugins.some(p =&gt; p instanceof CleanWebpackPlugin);

        if (!hasCleanWebpackPlugin) {
          wConfig.plugins.push(new CleanWebpackPlugin([
            directories.dist.split(path.sep).pop(),
          ], {
            root: path.dirname(directories.dist),
          }));
          cleanDistFolder = true;
        }
      }

      if (!copyPublicFolder) {
        wConfig.plugins.push(new CopyWebpackPlugin([{
          from: path.join(directories.src, &apos;public&apos;),
          to: directories.build,
        }]));
        copyPublicFolder = true;
      }

      wConfig.module.rules.forEach((rule, index) =&gt; {
        if (isBabelRule(rule)) {
          // eslint-disable-next-line
          wConfig.module.rules[index] = webRule({ hot: false });
        }


        if (isImageRule(rule) &amp;&amp; !hasSyncedFileLoader(rule)) {
          if (rule.use) {
            // eslint-disable-next-line
            rule.use = SyncedFilesPlugin.loader(rule.use)
          }
          if (rule.oneOf) {
            // eslint-disable-next-line
            rule.oneOf = SyncedFilesPlugin.loaderOneOf(rule.oneOf)
          }
        }
      });

      const hasSyncedFilePlugin = wConfig.plugins.some(p =&gt; p instanceof SyncedFilesPlugin);
      if (!hasSyncedFilePlugin) {
        wConfig.plugins.push(new SyncedFilesPlugin({
          outputPath: directories.dist,
        }));
      }

      const hasExtractEmittedAssets = wConfig.plugins.some(p =&gt; p instanceof ExtractEmittedAssets);
      if (!hasExtractEmittedAssets) {
        wConfig.plugins.push(new ExtractEmittedAssets({
          outputPath: directories.dist,
        }));
      }
    });
  }


  if (wType === &apos;server&apos;) {
    wConfigs.forEach((wConfig) =&gt; {
      if (wConfig.entry === path.resolve(process.env.LIB_ROOT, &apos;./src/server/server.js&apos;)) {
        // eslint-disable-next-line
        wConfig.entry = path.resolve(process.env.LIB_ROOT, &apos;./src/server/build.js&apos;);
      }
      if (!wConfig.externals) {
        // eslint-disable-next-line
        wConfig.externals = {};
      }

      // Add paw-assets as externals
      if (!wConfig.externals[&apos;pwa-assets&apos;]) {
        // eslint-disable-next-line
        wConfig.externals[&apos;pwa-assets&apos;] = &apos;./assets.json&apos;;
      }

      wConfig.module.rules.forEach((rule, index) =&gt; {
        if (isBabelRule(rule)) {
          // eslint-disable-next-line
          wConfig.module.rules[index] = serverRule({
            noChunk: true,
            hot: false,
          });
        }

        if (isImageRule(rule) &amp;&amp; !hasSyncedFileLoader(rule)) {
          if (rule.use) {
            // eslint-disable-next-line
            rule.use = SyncedFilesPlugin.loader(rule.use);
          }

          if (rule.oneOf) {
            // eslint-disable-next-line
            rule.oneOf = SyncedFilesPlugin.loaderOneOf(rule.oneOf)
          }
        }
      });

      const hasSyncedFilePlugin = wConfig.plugins.some(p =&gt; p instanceof SyncedFilesPlugin);
      if (!hasSyncedFilePlugin) {
        wConfig.plugins.push(new SyncedFilesPlugin({
          outputPath: directories.dist,
        }));
      }
    });
  }
});


try {
  // Server configurations
  const serverConfig = wHandler.getConfig(process.env.PAW_ENV, &apos;server&apos;);

  // Web client configurations
  const webConfig = wHandler.getConfig(process.env.PAW_ENV, &apos;web&apos;);

  // Create a webpack web compiler from the web configurations
  webpack(webConfig, (webErr, webStats) =&gt; {
    if (webErr || webStats.hasErrors()) {
      // Handle errors here
      // eslint-disable-next-line
      console.log(webStats.toJson());
      // eslint-disable-next-line
      console.log(&quot;Web compiler error occurred. Please handle error here&quot;);
      return;
    }
    // eslint-disable-next-line
    console.log(webStats.toString(stats));
    webpack(serverConfig, (serverErr, serverStats) =&gt; {
      if (serverErr || serverStats.hasErrors()) {
        // Handle errors here
        // eslint-disable-next-line
        console.log(&quot;Server Compiler error occurred. Please handle error here&quot;);
        return;
      }

      // eslint-disable-next-line
      console.log(serverStats.toString(stats));

      if (pawConfig.singlePageApplication) {
        // eslint-disable-next-line
        console.log(&quot;Creating static files...&quot;);

        const outputConfig = serverConfig[0].output;
        // eslint-disable-next-line
        let server = require(path.resolve(outputConfig.path, outputConfig.filename));
        server = server.default ? server.default : server;

        // eslint-disable-next-line
        console.log(&quot;Generating index.html &amp; manifest.json&quot;);

        Promise.all([
          request(server).get(&apos;/&apos;),
          request(server).get(&apos;/manifest.json&apos;),
        ]).then(([indexResponse, manifestResponse]) =&gt; {
          fs.writeFileSync(path.join(directories.build, &apos;index.html&apos;), indexResponse.text, &apos;utf-8&apos;);
          fs.writeFileSync(path.join(directories.build, &apos;manifest.json&apos;), manifestResponse.text, &apos;utf-8&apos;);

          // eslint-disable-next-line
          console.log(`Successfully created: ${path.join(directories.build, &quot;index.html&quot;)}`);
          // eslint-disable-next-line
          console.log(`Successfully created: ${path.join(directories.build, &quot;manifest.json&quot;)}`);
        }).then(() =&gt; {
          // eslint-disable-next-line
          console.log(&quot;\n\nRe-organizing files...\n&quot;);
          try {
            const tempPawJSBuildPath = path.join(directories.root, &apos;pawjs-temp-build&apos;);
            // Move to tempFolder
            del([tempPawJSBuildPath]).then(() =&gt; {
              mv(directories.build, tempPawJSBuildPath, { mkdir: true, clobber: true }, (err) =&gt; {
                if (err) {
                  // eslint-disable-next-line
                  console.error(err);
                  return;
                }
                del([directories.dist])
                  .then(() =&gt; {
                    mv(tempPawJSBuildPath, directories.dist, { clobber: true }, (err1) =&gt; {
                      if (err1) {
                        // eslint-disable-next-line
                        console.error(err1);
                        return;
                      }
                      // eslint-disable-next-line
                      console.log(&quot;Static site generated successfully.&quot;);
                      process.exit(0);
                    });
                  });
              });
            });
          } catch (ex) {
            // eslint-disable-next-line
            console.log(ex);
          }
        });
      }
    });
  });
} catch (ex) {
  // eslint-disable-next-line
  console.log(ex);
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
